<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Quiz Practice</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding-top: 80px; /* space for fixed header */
        background: #f4f4f4;
      }
      .fixed-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #007bff;
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 24px;
        z-index: 1000;
      }
      .container {
        padding: 20px;
      }
      #topicsList {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
      }
      .topic-item {
        background: white;
        padding: 10px 15px;
        border: 1px solid #ccc;
        cursor: pointer;
        border-radius: 5px;
      }
      .topic-item.selected {
        background: #28a745;
        color: white;
      }
      #questionsContainer {
        margin-top: 30px;
      }
      .question-card {
        background: white;
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .option {
        background: #eee;
        margin: 5px;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        flex: 1 1 auto; /* Allow options to grow and shrink based on available space */
        max-width: 150px; /* Limit the maximum width of options */
        text-align: center;
      }
      .question-card {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .question-card .options-container {
        display: flex;
        flex-wrap: wrap; /* Allows the options to wrap into multiple lines if needed */
        gap: 10px;
      }

      @media (max-width: 600px) {
        .question-card .options-container {
          flex-direction: column; /* Stack options vertically for smaller screens */
        }
      }

      .option.correct {
        background: #c8f7c5;
        color: green;
        animation: pop 0.4s ease;
      }
      .option.wrong {
        background: #f7c5c5;
        color: red;
      }
      @keyframes pop {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
      #searchBar {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        font-size: 16px;
      }
      #randomizeToggle {
        margin-bottom: 15px;
      }
      .highlight-next {
        animation: blink 0.8s ease-in-out;
      }

      @keyframes blink {
        0% {
          background-color: #ffeb3b;
        }
        50% {
          background-color: #fff176;
        }
        100% {
          background-color: white;
        }
      }
    </style>
  </head>
  <body>
    <div class="fixed-header">Score: <span id="score">0</span></div>

    <div class="container">
      <input type="text" id="searchBar" placeholder="Search Topics..." />

      <div id="randomizeToggle">
        <label
          ><input type="checkbox" id="randomizeQuestions" /> Randomize Question
          Order</label
        >
      </div>

      <div id="topicsList"></div>

      <div id="questionsContainer"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyA88fPkOvcI4QA9qD3ROpk-ay-V6ibQQlc",
        authDomain: "my-application-7fd40.firebaseapp.com",
        projectId: "my-application-7fd40",
        storageBucket: "my-application-7fd40.appspot.com",
        messagingSenderId: "269589994279",
        appId: "1:269589994279:web:4c617a622c328a1224e702",
        measurementId: "G-D8MD1J28GR",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const topicsList = document.getElementById("topicsList");
      const questionsContainer = document.getElementById("questionsContainer");
      const scoreSpan = document.getElementById("score");
      const searchBar = document.getElementById("searchBar");
      const randomizeCheckbox = document.getElementById("randomizeQuestions");

      let allTopics = [];
      let selectedTopics = new Set();
      let currentQuestions = [];
      let score = 0;

      function loadTopics() {
        db.collection("quiz")
          .get()
          .then((snapshot) => {
            allTopics = snapshot.docs.map((doc) => ({
              id: doc.id,
              data: doc.data(),
            }));
            showTopics(allTopics);
          });
      }

      function showTopics(topics) {
        topicsList.innerHTML = "";
        topics.forEach((topic) => {
          const div = document.createElement("div");
          div.className = "topic-item";
          div.textContent = topic.id;
          div.onclick = () => toggleTopic(topic.id);
          topicsList.appendChild(div);
        });
      }

      function toggleTopic(topicId) {
        if (selectedTopics.has(topicId)) {
          selectedTopics.delete(topicId);
        } else {
          selectedTopics.add(topicId);
        }
        updateTopicSelection();
        loadQuestions();
      }

      function updateTopicSelection() {
        document.querySelectorAll(".topic-item").forEach((item) => {
          if (selectedTopics.has(item.textContent)) {
            item.classList.add("selected");
          } else {
            item.classList.remove("selected");
          }
        });
      }

      function loadQuestions() {
        if (selectedTopics.size === 0) {
          questionsContainer.innerHTML = "<p>Select at least one topic</p>";
          return;
        }

        currentQuestions = [];
        const promises = Array.from(selectedTopics).map((topicId) =>
          db.collection("quiz").doc(topicId).get()
        );

        Promise.all(promises).then((docs) => {
          docs.forEach((doc) => {
            if (doc.exists) {
              const questions = doc.data().questions || [];
              currentQuestions.push(...questions);
            }
          });

          if (randomizeCheckbox.checked) {
            shuffleArray(currentQuestions);
          }

          renderQuestions();
        });
      }

      function renderQuestions() {
        questionsContainer.innerHTML = ""; // Clear previous content

        currentQuestions.forEach((q, idx) => {
          const card = document.createElement("div");
          card.className = "question-card";
          card.id = "question-" + idx;

          const qText = document.createElement("h3");
          qText.textContent = idx + 1 + ". " + q.question;
          card.appendChild(qText);

          const optionsContainer = document.createElement("div");
          optionsContainer.className = "options-container";

          q.options.forEach((opt) => {
            const optDiv = document.createElement("div");
            optDiv.className = "option";
            optDiv.textContent = opt.text;
            optDiv.onclick = () => handleAnswer(optDiv, opt.key, q.answer, idx);
            optionsContainer.appendChild(optDiv);
          });

          card.appendChild(optionsContainer);
          questionsContainer.appendChild(card);
        });
      }
      function handleAnswer(optionDiv, selected, correct, idx) {
        const options = optionDiv.parentElement.querySelectorAll(".option");
        options.forEach((opt) => (opt.style.pointerEvents = "none")); // disable further clicking

        if (selected.trim() === correct.trim()) {
          optionDiv.classList.add("correct");
          score++;
          scoreSpan.textContent = score;
        } else {
          optionDiv.classList.add("wrong");
          options.forEach((opt) => {
            if (opt.textContent.trim() === correct.trim()) {
              opt.classList.add("correct");
            }
          });
        }
        // Highlight next question
        setTimeout(() => {
          const nextCard = document.getElementById("question-" + (idx + 1));
          if (nextCard) {
            nextCard.classList.add("highlight-next");
            setTimeout(() => {
              nextCard.classList.remove("highlight-next");
            }, 800); // highlight stays for 800ms
          }
        }, 300); // slight delay after answering
      }

      function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      }

      searchBar.addEventListener("input", () => {
        const keyword = searchBar.value.toLowerCase();
        const filtered = allTopics.filter((topic) =>
          topic.id.toLowerCase().includes(keyword)
        );
        showTopics(filtered);
      });

      loadTopics();
    </script>
  </body>
</html>
